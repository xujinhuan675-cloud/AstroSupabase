---
/**
 * æ ‡ç­¾æ–‡ç« åˆ—è¡¨é¡µ - é™æ€ç”Ÿæˆç‰ˆæœ¬
 * 
 * ä¼˜åŒ–ç­–ç•¥ï¼š
 * 1. æ‰€æœ‰æ•°æ®åœ¨æ„å»ºæ—¶é€šè¿‡ getStaticPaths() è·å–
 * 2. è¿è¡Œæ—¶é›¶æ•°æ®åº“æŸ¥è¯¢
 */
// å¼ºåˆ¶é™æ€é¢„æ¸²æŸ“ï¼ˆæœ‰ getStaticPaths æ—¶è‡ªåŠ¨å¯ç”¨ï¼Œä½†æ˜¾å¼å£°æ˜æ›´æ¸…æ™°ï¼‰
export const prerender = true;

import Layout from '../../layout/Layout.astro';
import { db } from '../../db/client';
import { articles, articleTags } from '../../db/schema';
import { eq, and, desc } from 'drizzle-orm';

// å®šä¹‰ props ç±»å‹
interface TagPageProps {
  decodedTag: string;
  taggedArticles: Array<{
    id: number;
    title: string;
    excerpt: string | null;
    slug: string;
    createdAt: Date;
    publishedAt: Date | null;
  }>;
}

// æ„å»ºæ—¶è·å–æ‰€æœ‰æ ‡ç­¾åŠå…¶æ–‡ç« ï¼Œç”Ÿæˆé™æ€è·¯å¾„
export async function getStaticPaths() {
  console.log('[BUILD] Starting static path generation for tags...');
  
  // 1. è·å–æ‰€æœ‰å”¯ä¸€æ ‡ç­¾
  const allTags = await db
    .selectDistinct({ tag: articleTags.tag })
    .from(articleTags);
  
  console.log(`[BUILD] Found ${allTags.length} unique tags`);
  
  // 2. ä¸ºæ¯ä¸ªæ ‡ç­¾è·å–æ–‡ç« åˆ—è¡¨
  const paths = await Promise.all(allTags.map(async ({ tag }) => {
    const taggedArticles = await db
      .select({
        id: articles.id,
        title: articles.title,
        excerpt: articles.excerpt,
        slug: articles.slug,
        createdAt: articles.createdAt,
        publishedAt: articles.publishedAt,
      })
      .from(articles)
      .innerJoin(articleTags, eq(articles.id, articleTags.articleId))
      .where(and(
        eq(articleTags.tag, tag),
        eq(articles.status, 'published'),
        eq(articles.isDeleted, false)
      ))
      .orderBy(desc(articles.publishedAt));
    
    return {
      params: { tag: encodeURIComponent(tag) },
      props: {
        decodedTag: tag,
        taggedArticles,
      } as TagPageProps,
    };
  }));
  
  console.log('[BUILD] Tag static paths generated');
  return paths;
}

// ä» props è·å–æ‰€æœ‰æ•°æ®ï¼ˆæ„å»ºæ—¶å·²å‡†å¤‡å¥½ï¼Œè¿è¡Œæ—¶é›¶æŸ¥è¯¢ï¼‰
const { decodedTag, taggedArticles } = Astro.props as TagPageProps;
---

<Layout title={`æ ‡ç­¾: ${decodedTag}`}>
  <div class="max-w-4xl mx-auto px-4 py-10">
    <!-- è¿”å›å¯¼èˆª -->
    <nav class="mb-8">
      <a 
        href="/" 
        class="text-base font-medium flex items-center gap-1 inline-flex hover:opacity-80"
        style="color: var(--secondary);"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        è¿”å›é¦–é¡µ
      </a>
    </nav>

    <!-- æ ‡ç­¾æ ‡é¢˜ -->
    <header class="mb-10">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-5xl">ğŸ·ï¸</span>
        <h1 class="text-4xl font-extrabold" style="color: var(--dark);">
          {decodedTag}
        </h1>
      </div>
      <p class="text-lg" style="color: var(--gray);">
        å…± {taggedArticles.length} ç¯‡æ–‡ç« åŒ…å«æ­¤æ ‡ç­¾
      </p>
    </header>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    {taggedArticles.length > 0 ? (
      <div class="space-y-6">
        {taggedArticles.map((article) => {
          const formattedDate = new Date(article.publishedAt || article.createdAt).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          
          return (
            <article class="rounded-lg p-6 hover:shadow-lg transition-shadow" style="background-color: var(--light); border: 1px solid var(--lightgray);">
              <a href={`/articles/${article.id}`}>
                <h2 class="text-2xl font-bold mb-2 transition-colors hover:opacity-80" style="color: var(--dark);">
                  {article.title}
                </h2>
              </a>
              
              {article.excerpt && (
                <p class="mb-4 line-clamp-3" style="color: var(--gray);">
                  {article.excerpt}
                </p>
              )}
              
              <div class="flex items-center text-sm" style="color: var(--gray);">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                {formattedDate}
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-xl" style="color: var(--gray);">æš‚æ— æ–‡ç« åŒ…å«æ­¤æ ‡ç­¾</p>
      </div>
    )}

    <!-- åº•éƒ¨æ“ä½œ -->
    <div class="mt-12 pt-8 flex justify-between items-center" style="border-top: 1px solid var(--lightgray);">
      <a 
        href="/" 
        class="flex items-center gap-2 hover:opacity-80"
        style="color: var(--gray);"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        è¿”å›åˆ—è¡¨
      </a>
    </div>
  </div>
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

