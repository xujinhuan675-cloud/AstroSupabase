---
/**
 * æ–‡ç« è¯¦æƒ…é¡µ - é™æ€ç”Ÿæˆç‰ˆæœ¬
 * 
 * ä¼˜åŒ–ç­–ç•¥ï¼š
 * 1. æ‰€æœ‰æ•°æ®åœ¨æ„å»ºæ—¶é€šè¿‡ getStaticPaths() è·å–
 * 2. è¿è¡Œæ—¶é›¶æ•°æ®åº“æŸ¥è¯¢
 * 3. é¡µé¢éƒ¨ç½²åˆ° Edge CDNï¼Œå…¨çƒåŠ é€Ÿ
 */
import { getArticleById } from '../../lib/articles';
import { processMarkdown } from '../../lib/markdown-processor';
import { getArticleTags, getForwardLinks, getBacklinks } from '../../lib/links-service';
import { db } from '../../db/client';
import { articles, articleTags, articleLinks } from '../../db/schema';
import { eq, and, inArray } from 'drizzle-orm';
import QuartzLayout from '../../layouts/QuartzLayout.astro';
import Backlinks from '../../components/Backlinks';
import TableOfContents from '../../components/quartz/TableOfContents';
import Breadcrumbs from '../../components/quartz/Breadcrumbs';
import ContentMeta from '../../components/quartz/ContentMeta';
import TagList from '../../components/quartz/TagList';
import Darkmode from '../../components/quartz/Darkmode';
import ReaderMode from '../../components/quartz/ReaderMode';
import Search from '../../components/quartz/Search';
import Explorer from '../../components/quartz/Explorer';
import QuartzGraph from '../../components/quartz/QuartzGraph';
import MainNav from '../../components/MainNav.astro';
import type { Article } from '../../db/schema';

// å®šä¹‰ props ç±»å‹
interface ArticlePageProps {
  article: Article;
  tags: string[];
  forwardLinks: Array<{ id: number; title: string; slug: string; excerpt: string | null }>;
  backlinks: Array<{ id: number; title: string; slug: string; excerpt: string | null }>;
  allArticlesForExplorer: Array<{ id: number; title: string; tags: string[] }>;
  processedHtml: string;
  readingTime: string;
}

// æ„å»ºæ—¶è·å–æ‰€æœ‰æ–‡ç« æ•°æ®ï¼Œç”Ÿæˆé™æ€é¡µé¢
export async function getStaticPaths() {
  console.log('[BUILD] Starting static path generation for articles...');
  const buildStart = Date.now();
  
  // 1. è·å–æ‰€æœ‰å·²å‘å¸ƒæ–‡ç« çš„å®Œæ•´æ•°æ®
  const allArticles = await db
    .select()
    .from(articles)
    .where(and(
      eq(articles.status, 'published'),
      eq(articles.isDeleted, false)
    ));
  
  console.log(`[BUILD] Found ${allArticles.length} published articles`);
  
  // 2. æ‰¹é‡è·å–æ‰€æœ‰æ ‡ç­¾ï¼ˆé¿å… N+1 æŸ¥è¯¢ï¼‰
  const allTagsData = await db
    .select({
      articleId: articleTags.articleId,
      tag: articleTags.tag,
    })
    .from(articleTags)
    .innerJoin(articles, eq(articleTags.articleId, articles.id))
    .where(and(
      eq(articles.status, 'published'),
      eq(articles.isDeleted, false)
    ));
  
  // æ„å»ºæ ‡ç­¾æ˜ å°„ï¼šarticleId -> tags[]
  const tagsMap = new Map<number, string[]>();
  allTagsData.forEach(({ articleId, tag }) => {
    if (!tagsMap.has(articleId)) {
      tagsMap.set(articleId, []);
    }
    tagsMap.get(articleId)!.push(tag);
  });

  // 3. æ‰¹é‡è·å–æ‰€æœ‰é“¾æ¥å…³ç³»
  const allLinksData = await db
    .select({
      sourceId: articleLinks.sourceId,
      targetId: articleLinks.targetId,
    })
    .from(articleLinks);
  
  // æ„å»ºé“¾æ¥æ˜ å°„
  const forwardLinksMap = new Map<number, number[]>();
  const backlinksMap = new Map<number, number[]>();
  
  allLinksData.forEach(({ sourceId, targetId }) => {
    // å‰å‘é“¾æ¥ï¼šsourceId -> targetId
    if (!forwardLinksMap.has(sourceId)) {
      forwardLinksMap.set(sourceId, []);
    }
    forwardLinksMap.get(sourceId)!.push(targetId);
    
    // åå‘é“¾æ¥ï¼štargetId <- sourceId
    if (!backlinksMap.has(targetId)) {
      backlinksMap.set(targetId, []);
    }
    backlinksMap.get(targetId)!.push(sourceId);
  });
  
  // 4. æ„å»ºæ–‡ç«  ID -> æ–‡ç« æ•°æ®çš„æ˜ å°„ï¼ˆç”¨äºé“¾æ¥ä¿¡æ¯ï¼‰
  const articleMap = new Map(allArticles.map(a => [a.id, a]));
  
  // 5. ä¸º Explorer å‡†å¤‡çš„æ–‡ç« åˆ—è¡¨ï¼ˆå«æ ‡ç­¾ï¼‰
  const allArticlesForExplorer = allArticles.map(article => ({
    id: article.id,
    title: article.title,
    tags: tagsMap.get(article.id) || [],
  }));
  
  // 6. è·å–æ‰€æœ‰æ–‡ç«  slugï¼ˆç”¨äº Markdown å¤„ç†ï¼‰
  const allArticleSlugs = new Set(allArticles.map(a => a.slug));
  
  // 7. ä¸ºæ¯ç¯‡æ–‡ç« ç”Ÿæˆé™æ€è·¯å¾„å’Œ props
  const paths = await Promise.all(allArticles.map(async (article) => {
    // è·å–æ ‡ç­¾
    const tags = tagsMap.get(article.id) || [];
    
    // è·å–å‰å‘é“¾æ¥è¯¦æƒ…
    const forwardLinkIds = forwardLinksMap.get(article.id) || [];
    const forwardLinks = forwardLinkIds
      .map(id => articleMap.get(id))
      .filter((a): a is Article => a !== undefined && a.status === 'published' && !a.isDeleted)
      .map(a => ({
        id: a.id,
        title: a.title,
        slug: a.slug,
        excerpt: a.excerpt,
      }));
    
    // è·å–åå‘é“¾æ¥è¯¦æƒ…
    const backlinkIds = backlinksMap.get(article.id) || [];
    const backlinks = backlinkIds
      .map(id => articleMap.get(id))
      .filter((a): a is Article => a !== undefined && a.status === 'published' && !a.isDeleted)
      .map(a => ({
        id: a.id,
        title: a.title,
        slug: a.slug,
        excerpt: a.excerpt,
      }));
    
    // å¤„ç† Markdownï¼ˆä½¿ç”¨ç¼“å­˜æˆ–å®æ—¶å¤„ç†ï¼‰
    let processedHtml: string;
    let readingTime: string;
    
    if (article.htmlContent && article.readingTime) {
      // ä½¿ç”¨é¢„æ¸²æŸ“ç¼“å­˜
      processedHtml = article.htmlContent;
      readingTime = article.readingTime;
    } else {
      // æ„å»ºæ—¶å¤„ç† Markdown
      console.warn(`[BUILD] Article ${article.id} has no cached HTML, processing...`);
      const processed = await processMarkdown(
        article.content,
        {},
        async (permalink: string) => allArticleSlugs.has(permalink)
      );
      processedHtml = processed.html;
      readingTime = processed.readingTime;
    }
    
    return {
      params: { id: article.id.toString() },
      props: {
        article,
        tags,
        forwardLinks,
        backlinks,
        allArticlesForExplorer,
        processedHtml,
        readingTime,
      } as ArticlePageProps,
    };
  }));
  
  console.log(`[BUILD] Static paths generated in ${Date.now() - buildStart}ms`);
  return paths;
}

// ä» props è·å–æ‰€æœ‰æ•°æ®ï¼ˆæ„å»ºæ—¶å·²å‡†å¤‡å¥½ï¼Œè¿è¡Œæ—¶é›¶æŸ¥è¯¢ï¼‰
const { article, tags, forwardLinks, backlinks, allArticlesForExplorer, processedHtml, readingTime } = Astro.props as ArticlePageProps;
const { id } = Astro.params;

// æ ¼å¼åŒ–æ—¥æœŸ
const formattedDate = new Date(article.publishedAt || article.createdAt).toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<QuartzLayout title={article.title} currentSlug={`articles/${id}`}>
  <!-- ä¸»å¯¼èˆªæ  -->
  <div slot="header">
    <MainNav />
  </div>
  
  <!-- Left Sidebar -->
  <div slot="left-sidebar">
    <!-- Search, Darkmode & ReaderMode åŒä¸€è¡Œ -->
    <div class="search-controls-row">
      <Search client:idle enablePreview={true} />
      <div class="control-icons">
        <Darkmode client:load />
        <ReaderMode client:idle />
      </div>
    </div>
    
    <!-- Explorer æ–‡ä»¶æµè§ˆå™¨ - ä½¿ç”¨æ„å»ºæ—¶é™æ€æ•°æ® -->
    <Explorer 
      client:idle 
      title="æ–‡ç« æµè§ˆ" 
      folderDefaultState="open"
      initialData={allArticlesForExplorer}
    />
  </div>

  <!-- Right Sidebar -->
  <div slot="right-sidebar">
    <!-- å±€éƒ¨çŸ¥è¯†å›¾è°± - å¯è§æ—¶æ‰åŠ è½½ -->
    <QuartzGraph 
      client:visible
      currentSlug={article.slug}
      height={250}
      localGraph={{ depth: 1 }}
    />
    
    <!-- ç›®å½• - æµè§ˆå™¨ç©ºé—²æ—¶åŠ è½½ -->
    <TableOfContents client:idle />
  </div>

  <!-- Before Body (Breadcrumbs, Meta, Tags) -->
  <div slot="before-body">
    <Breadcrumbs 
      items={[
        { label: 'é¦–é¡µ', path: '/' },
        { label: 'æ–‡ç« ', path: '/blog' },
        { label: article.title, path: `/articles/${id}` }
      ]}
    />
    
    <ContentMeta 
      publishedAt={new Date(article.publishedAt || article.createdAt)}
      readingTime={readingTime}
      author={article.authorId.toString()}
    />
    
    {tags.length > 0 && (
      <TagList tags={tags} />
    )}
  </div>

  <!-- Main Content -->
  <article>
    {/* Popover é¢„è§ˆæç¤ºå†…å®¹ */}
    <div class="popover-hint">
      <header class="mb-8">
        <h1 class="text-4xl font-extrabold mb-4 leading-tight" style="color: var(--dark);">
          {article.title}
        </h1>

        {/* æ‘˜è¦ */}
        {article.excerpt && (
          <p class="text-xl mb-4 leading-relaxed" style="color: var(--gray);">
            {article.excerpt}
          </p>
        )}

        {/* å‰å‘é“¾æ¥æç¤º */}
        {forwardLinks.length > 0 && (
          <div class="text-sm mb-4" style="color: var(--gray);">
            é“¾æ¥åˆ° {forwardLinks.length} ç¯‡æ–‡ç« 
          </div>
        )}
      </header>
      
      {/* Markdown æ¸²æŸ“å†…å®¹ */}
      <div 
        class="prose prose-indigo prose-lg max-w-none"
        style="color: var(--dark);"
        set:html={processedHtml}
      />
    </div>

    {/* å‰å‘é“¾æ¥ï¼ˆæ–‡ç« é“¾æ¥åˆ°çš„å…¶ä»–æ–‡ç« ï¼‰ */}
    {forwardLinks.length > 0 && (
      <div class="mt-12 p-6 rounded-lg" style="border: 1px solid var(--lightgray); background-color: var(--highlight);">
        <h3 class="text-lg font-semibold mb-4" style="color: var(--dark);">
          ğŸ”— ç›¸å…³é“¾æ¥ ({forwardLinks.length})
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          {forwardLinks.map((link) => (
            <a
              href={`/articles/${link.id}`}
              class="block p-3 rounded-md transition-colors"
              style="background-color: var(--light); border: 1px solid transparent;"
            >
              <h4 class="font-medium" style="color: var(--secondary);">
                {link.title}
              </h4>
              {link.excerpt && (
                <p class="text-sm mt-1 line-clamp-2" style="color: var(--gray);">
                  {link.excerpt}
                </p>
              )}
            </a>
          ))}
        </div>
      </div>
    )}

    {/* åå‘é“¾æ¥ç»„ä»¶ - æ•°æ®å·²åœ¨æ„å»ºæ—¶è·å– */}
    <Backlinks articleId={article.id} backlinks={backlinks} client:idle />
  </article>
</QuartzLayout>


<style>
  /* å¢å¼º prose æ ·å¼ä»¥æ”¯æŒåŒå‘é“¾æ¥ */
  .prose a {
    color: var(--secondary);
    text-decoration: underline;
    text-decoration-color: var(--secondary);
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }
  
  .prose a:hover {
    opacity: 0.8;
  }
  
  .prose code {
    background-color: var(--highlight);
    color: var(--dark);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .prose pre {
    background-color: var(--darkgray);
    color: var(--lightgray);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
  }

  .prose pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    color: var(--dark);
  }
  
  .prose p, .prose li {
    color: var(--dark);
  }
  
  /* æœç´¢å’Œæ§åˆ¶å›¾æ ‡è¡Œå¸ƒå±€ */
  .search-controls-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .control-icons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  /* æ§åˆ¶å›¾æ ‡æŒ‰é’®æ ·å¼ */
  .control-icons .darkmode,
  .control-icons .readermode {
    border: 1px solid var(--lightgray);
    border-radius: 5px;
    padding: 0.5rem;
    background: var(--light);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .control-icons .darkmode:hover,
  .control-icons .readermode:hover {
    border-color: var(--secondary);
    background: var(--highlight);
  }
  
  .control-icons .darkmode svg,
  .control-icons .readermode svg {
    display: block;
  }
</style>
