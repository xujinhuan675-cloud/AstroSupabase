---
import { getArticleById } from '../../lib/articles';
import { processMarkdown } from '../../lib/markdown-processor';
import { getArticleTags, getForwardLinks } from '../../lib/links-service';
import { db } from '../../db/client';
import { articles } from '../../db/schema';
import { eq } from 'drizzle-orm';
import QuartzLayout from '../../layouts/QuartzLayout.astro';
import Backlinks from '../../components/Backlinks';
import TableOfContents from '../../components/quartz/TableOfContents';
import PageTitle from '../../components/quartz/PageTitle';
import Breadcrumbs from '../../components/quartz/Breadcrumbs';
import ContentMeta from '../../components/quartz/ContentMeta';
import TagList from '../../components/quartz/TagList';
import Darkmode from '../../components/quartz/Darkmode';
import ReaderMode from '../../components/quartz/ReaderMode';
import Search from '../../components/quartz/Search';
import Explorer from '../../components/quartz/Explorer';
import LocalGraph from '../../components/LocalGraph';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

const articleId = parseInt(id);

if (isNaN(articleId)) {
  return Astro.redirect('/404');
}

const article = await getArticleById(articleId);

if (!article) {
  return Astro.redirect('/404');
}

// å¹¶è¡ŒæŸ¥è¯¢æ ‡ç­¾å’Œå‰å‘é“¾æ¥
const [tags, forwardLinks] = await Promise.all([
  getArticleTags(articleId),
  getForwardLinks(articleId),
]);

// ä½¿ç”¨ç¼“å­˜çš„ HTML æˆ–å®æ—¶å¤„ç† Markdown
let processed: { html: string; readingTime: string; };

if (article.htmlContent && article.readingTime) {
  // ä½¿ç”¨ç¼“å­˜çš„ HTMLï¼ˆæå¿«ï¼ï¼‰
  processed = {
    html: article.htmlContent,
    readingTime: article.readingTime,
  };
} else {
  // ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦å¤„ç† Markdownï¼ˆé¦–æ¬¡è®¿é—®æˆ–å†…å®¹æ›´æ–°åï¼‰
  const allArticleSlugs = await db
    .select({ slug: articles.slug })
    .from(articles)
    .where(eq(articles.status, 'published'))
    .then(results => new Set(results.map(r => r.slug)));

  processed = await processMarkdown(
    article.content,
    {}, // options
    async (permalink: string) => {
      return allArticleSlugs.has(permalink);
    }
  );

  // æ›´æ–°ç¼“å­˜ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡é¡µé¢æ¸²æŸ“ï¼‰
  db.update(articles)
    .set({
      htmlContent: processed.html,
      readingTime: processed.readingTime,
    })
    .where(eq(articles.id, articleId))
    .then(() => console.log(`Cached HTML for article ${articleId}`))
    .catch(err => console.error('Failed to cache HTML:', err));
}

const formattedDate = new Date(article.publishedAt || article.createdAt).toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<QuartzLayout title={article.title} currentSlug={`articles/${id}`}>
  <!-- Left Sidebar -->
  <div slot="left-sidebar">
    <!-- PageTitle ç»„ä»¶ -->
    <PageTitle title="I want to learn" client:load />
    
    <!-- Search, Darkmode & ReaderMode åŒä¸€è¡Œ -->
    <div class="search-controls-row">
      <Search client:only="react" enablePreview={true} />
      <div class="control-icons">
        <Darkmode client:only="react" />
        <ReaderMode client:only="react" />
      </div>
    </div>
    
    <!-- Explorer æ–‡ä»¶æµè§ˆå™¨ -->
    <Explorer client:only="react" title="æ–‡ç« æµè§ˆ" folderDefaultState="open" />
  </div>

  <!-- Right Sidebar -->
  <div slot="right-sidebar">
    <!-- å±€éƒ¨çŸ¥è¯†å›¾è°± -->
    <LocalGraph articleId={articleId} client:load />
    
    <!-- ç›®å½• -->
    <TableOfContents client:load />
  </div>

  <!-- Before Body (Breadcrumbs, Meta, Tags) -->
  <div slot="before-body">
    <Breadcrumbs 
      items={[
        { label: 'é¦–é¡µ', path: '/' },
        { label: 'æ–‡ç« ', path: '/articles' },
        { label: article.title, path: `/articles/${id}` }
      ]}
      client:load
    />
    
    <ContentMeta 
      publishedAt={new Date(article.publishedAt || article.createdAt)}
      readingTime={processed.readingTime}
      author={article.authorId.toString()}
      client:load
    />
    
    {tags.length > 0 && (
      <TagList tags={tags} client:load />
    )}
  </div>

  <!-- Main Content -->
  <article>
    {/* Popover é¢„è§ˆæç¤ºå†…å®¹ */}
    <div class="popover-hint">
      <header class="mb-8">
        <h1 class="text-4xl font-extrabold mb-4 leading-tight" style="color: var(--dark);">
          {article.title}
        </h1>

        {/* æ‘˜è¦ */}
        {article.excerpt && (
          <p class="text-xl mb-4 leading-relaxed" style="color: var(--gray);">
            {article.excerpt}
          </p>
        )}

        {/* å‰å‘é“¾æ¥æç¤º */}
        {forwardLinks.length > 0 && (
          <div class="text-sm mb-4" style="color: var(--gray);">
            é“¾æ¥åˆ° {forwardLinks.length} ç¯‡æ–‡ç« 
          </div>
        )}
      </header>
      
      {/* Markdown æ¸²æŸ“å†…å®¹ */}
      <div 
        class="prose prose-indigo prose-lg max-w-none"
        style="color: var(--dark);"
        set:html={processed.html}
      />
    </div>

    {/* å‰å‘é“¾æ¥ï¼ˆæ–‡ç« é“¾æ¥åˆ°çš„å…¶ä»–æ–‡ç« ï¼‰ */}
    {forwardLinks.length > 0 && (
      <div class="mt-12 p-6 rounded-lg" style="border: 1px solid var(--lightgray); background-color: var(--highlight);">
        <h3 class="text-lg font-semibold mb-4" style="color: var(--dark);">
          ğŸ”— ç›¸å…³é“¾æ¥ ({forwardLinks.length})
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          {forwardLinks.map((link) => (
            <a
              href={`/articles/${link.id}`}
              class="block p-3 rounded-md transition-colors"
              style="background-color: var(--light); border: 1px solid transparent;"
            >
              <h4 class="font-medium" style="color: var(--secondary);">
                {link.title}
              </h4>
              {link.excerpt && (
                <p class="text-sm mt-1 line-clamp-2" style="color: var(--gray);">
                  {link.excerpt}
                </p>
              )}
            </a>
          ))}
        </div>
      </div>
    )}

    {/* åå‘é“¾æ¥ç»„ä»¶ */}
    <Backlinks articleId={articleId} client:load />
  </article>
</QuartzLayout>

<style>
  /* å¢å¼º prose æ ·å¼ä»¥æ”¯æŒåŒå‘é“¾æ¥ */
  .prose a {
    color: var(--secondary);
    text-decoration: underline;
    text-decoration-color: var(--secondary);
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }
  
  .prose a:hover {
    opacity: 0.8;
  }
  
  /* å†…éƒ¨é“¾æ¥æ ‡è®°ï¼ˆç”¨äº Popoverï¼‰ */
  .prose a[href^="/articles/"],
  .prose a[href^="/tags/"] {
    /* ä¸ºå†…éƒ¨é“¾æ¥æ·»åŠ  internal ç±»é€šè¿‡ JS å¤„ç† */
  }
  
  .prose code {
    background-color: var(--highlight);
    color: var(--dark);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .prose pre {
    background-color: var(--darkgray);
    color: var(--lightgray);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
  }

  .prose pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    color: var(--dark);
  }
  
  .prose p, .prose li {
    color: var(--dark);
  }
  
  /* æœç´¢å’Œæ§åˆ¶å›¾æ ‡è¡Œå¸ƒå±€ */
  .search-controls-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .control-icons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  /* æ§åˆ¶å›¾æ ‡æŒ‰é’®æ ·å¼ */
  .control-icons .darkmode,
  .control-icons .readermode {
    border: 1px solid var(--lightgray);
    border-radius: 5px;
    padding: 0.5rem;
    background: var(--light);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .control-icons .darkmode:hover,
  .control-icons .readermode:hover {
    border-color: var(--secondary);
    background: var(--highlight);
  }
  
  .control-icons .darkmode svg,
  .control-icons .readermode svg {
    display: block;
  }
</style>
