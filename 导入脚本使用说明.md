# 📦 导入脚本使用说明

## 🎯 导入脚本运行位置

### 运行环境

```
本地电脑 (Windows)
  ↓ 执行命令
npm run import
  ↓ 读取
本地 Markdown 文件 (content/articles/*.md)
  ↓ 网络连接
Supabase 数据库 (远程 PostgreSQL)
  ↓ 写入数据
articles, article_tags, article_links 表
```

### 角色分工

| 组件 | 角色 | 说明 |
|------|------|------|
| 🖥️ **本地电脑** | 运行导入脚本 | 执行 `npm run import` |
| 📁 **本地文件** | 数据源 | `content/articles/*.md` |
| 🗄️ **Supabase** | 数据存储 | 远程 PostgreSQL 数据库 |
| 🌐 **Vercel** | 网站部署 | 不参与导入，只负责展示 |

---

## 🚀 使用步骤

### Step 1: 配置环境变量

**创建 `.env` 文件**（在 `F:\IOTO-Doc\AstroSupabase\` 目录）：

```bash
# 复制示例文件
copy .env.example .env
```

**编辑 `.env` 文件**，填入你的 Supabase 信息：

```env
DATABASE_URL=postgresql://postgres:[密码]@db.[项目ID].supabase.co:5432/postgres
PUBLIC_SUPABASE_URL=https://[项目ID].supabase.co
PUBLIC_SUPABASE_ANON_KEY=你的-anon-key
PUBLIC_SITE_URL=http://localhost:4321
```

### Step 2: 获取 Supabase 连接信息

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧 **Settings** → **Database**
4. 在 **Connection string** 部分找到：
   - **URI**: 就是你的 `DATABASE_URL`
   - 将 `[YOUR-PASSWORD]` 替换为你的数据库密码
5. 点击 **API Settings** 获取：
   - **Project URL**: 就是 `PUBLIC_SUPABASE_URL`
   - **anon public**: 就是 `PUBLIC_SUPABASE_ANON_KEY`

### Step 3: 准备 Markdown 文件

将文章放在 `content/articles/` 目录：

```
AstroSupabase/
└── content/
    └── articles/
        ├── example.md        ✅ (已有)
        ├── my-note.md        ⬅️ 你的文章
        └── another-note.md   ⬅️ 你的文章
```

**Markdown 文件格式**：

```markdown
---
title: "文章标题"
slug: "article-slug"  # 可选，不填会自动生成
excerpt: "文章摘要"
tags: [标签1, 标签2]
author: "作者名"
status: published  # 或 draft
---

# 正文标题

这是文章内容。

使用 [[双向链接]] 语法链接其他文章。
使用 #标签 标记内容。
```

### Step 4: 执行导入

```bash
cd F:\IOTO-Doc\AstroSupabase
npm run import
```

### Step 5: 查看结果

导入成功后，访问：
- 📝 文章列表：http://localhost:4321
- 🌐 知识图谱：http://localhost:4321/graph

---

## 📂 文章来源位置

### ✅ 选项 1: 专用目录（推荐）

```
F:\IOTO-Doc\AstroSupabase\content\articles\
```

**优点**：
- ✅ 与项目集成
- ✅ 路径已配置
- ✅ 版本控制友好

### 🔄 选项 2: IOTO 框架目录

从 IOTO 框架复制文件：

```powershell
# 从碎片笔记导入
copy "F:\IOTO-Doc\1-Input\2-碎片笔记\*.md" "F:\IOTO-Doc\AstroSupabase\content\articles\"

# 从系统笔记导入
copy "F:\IOTO-Doc\1-Input\4-系统笔记\*.md" "F:\IOTO-Doc\AstroSupabase\content\articles\"

# 从卡片笔记导入
copy "F:\IOTO-Doc\2-Output\2-卡片笔记\*.md" "F:\IOTO-Doc\AstroSupabase\content\articles\"
```

然后运行：

```bash
npm run import
```

### 🔧 选项 3: 修改导入路径

编辑 `scripts/import-markdown.ts`：

```typescript
// 找到这一行（约第 76 行）
const contentDir = join(process.cwd(), 'content', 'articles');

// 改为你的路径
const contentDir = 'F:/IOTO-Doc/1-Input/4-系统笔记';
```

然后运行导入命令。

---

## 🔍 导入流程详解

### 1. 扫描文件
```
📂 扫描 content/articles/ 目录
   ↓
找到所有 .md 文件
```

### 2. 解析 Markdown
```
📄 读取文件内容
   ↓
解析 frontmatter（标题、标签等）
   ↓
提取正文内容
   ↓
识别 [[双向链接]] 和 #标签
```

### 3. 检查重复
```
🔍 检查 slug 是否已存在
   ↓
存在 → 跳过
不存在 → 继续
```

### 4. 写入数据库
```
💾 插入到 articles 表
   ↓
解析链接关系 → articleLinks 表
   ↓
提取标签 → articleTags 表
```

### 5. 完成
```
✅ 显示统计信息
   - 成功: X 篇
   - 跳过: Y 篇
   - 失败: Z 篇
```

---

## 🔄 工作流示例

### 场景 1: Obsidian → AstroSupabase

```bash
# 1. 在 Obsidian 中编写笔记
# 位置: 任意 Obsidian Vault

# 2. 复制到导入目录
copy "C:\MyObsidianVault\MyNote.md" "F:\IOTO-Doc\AstroSupabase\content\articles\"

# 3. 导入到数据库
cd F:\IOTO-Doc\AstroSupabase
npm run import

# 4. 启动网站查看
npm run dev
# 访问 http://localhost:4321
```

### 场景 2: IOTO 框架 → AstroSupabase

```bash
# 1. 批量复制 IOTO 笔记
copy "F:\IOTO-Doc\1-Input\4-系统笔记\*.md" "F:\IOTO-Doc\AstroSupabase\content\articles\"

# 2. 导入
npm run import

# 3. 查看知识图谱
npm run dev
# 访问 http://localhost:4321/graph
```

### 场景 3: 直接从 IOTO 目录导入

编辑 `scripts/import-markdown.ts`：

```typescript
const contentDir = 'F:/IOTO-Doc/1-Input/4-系统笔记';
```

然后：

```bash
npm run import
```

---

## ⚠️ 常见问题

### Q1: `DATABASE_URL is not set` 错误

**原因**: 没有配置 `.env` 文件

**解决**:
```bash
# 创建 .env 文件
copy .env.example .env

# 编辑 .env 填入 Supabase 信息
```

### Q2: 导入后文章不显示

**原因**: 文章状态可能是 `draft`

**解决**: 将 frontmatter 中的 `status` 改为 `published`：

```yaml
---
title: "文章标题"
status: published  # 改这里
---
```

### Q3: 链接无法解析

**原因**: 目标文章不存在或 slug 不匹配

**解决**:
1. 确保被链接的文章已导入
2. 检查 slug 是否匹配
3. 重新运行导入更新链接关系

### Q4: 找不到 content/articles 目录

**解决**:

```bash
# 创建目录
mkdir content\articles

# 或者修改导入脚本路径
```

---

## 📊 导入统计

导入成功后会显示：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 导入统计:
   ✅ 成功: 5 篇
   ⏭️  跳过: 2 篇
   ❌ 失败: 0 篇
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 导入完成！访问 http://localhost:4321 查看文章
```

**统计说明**：
- **成功**: 新导入的文章数量
- **跳过**: 已存在的文章（根据 slug 判断）
- **失败**: 导入出错的文章

---

## 🎯 最佳实践

### 1. 文章组织

```
content/articles/
├── drafts/              # 草稿（可选）
├── published/           # 已发布（可选）
└── *.md                 # 直接放在根目录也可以
```

### 2. 文件命名

```
✅ 好的命名:
- my-first-note.md
- react-hooks-guide.md
- 2024-01-15-weekly-review.md

❌ 避免:
- 未命名.md
- temp.md
- test123.md
```

### 3. 批量导入流程

```bash
# 1. 先导入基础文章（不含链接）
npm run import

# 2. 再导入引用文章（含链接）
npm run import

# 3. 链接会自动建立
```

---

## 🔮 高级用法

### 自动监听文件变化（计划中）

未来可以使用 `chokidar` 监听文件变化自动导入：

```bash
npm run watch:import  # 计划中的功能
```

### 批量更新链接

如果手动修改了数据库中的文章，运行此命令更新所有链接：

```bash
npm run update:links  # 需要自己创建脚本
```

---

## 📚 相关文档

- [QUICKSTART.md](./QUICKSTART.md) - 快速开始
- [QUARTZ_USAGE_GUIDE.md](./QUARTZ_USAGE_GUIDE.md) - 完整使用手册
- [集成完成总结.md](./集成完成总结.md) - 集成总结

---

**总结**: 导入脚本在你的**本地电脑**运行，读取**本地 Markdown 文件**，写入**Supabase 远程数据库**。Vercel 只负责部署网站，不参与导入过程。

