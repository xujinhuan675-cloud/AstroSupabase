# 知识图谱修复 - 快速验证指南

## 🎯 修复内容总结

已完成以下修复：

1. ✅ 修复动态导入问题（使用 React.lazy + Suspense）
2. ✅ 修复 SSR/CSR 冲突（改用 `client:only="react"`）
3. ✅ 修复类型错误（移除不支持的 `linkOpacity` 属性）

## 🚀 快速验证步骤

### 步骤 1: 测试数据接口

```bash
# 运行测试脚本
npm run test:graph
```

**预期输出**:
```
🧪 开始测试知识图谱数据...

1️⃣ 测试 getGraphData()...
   ✅ 节点数量: 10
   ✅ 链接数量: 15

2️⃣ 测试节点结构...
   ✅ 节点结构正确

3️⃣ 测试链接结构...
   ✅ 链接结构正确
   ✅ 所有链接都指向有效节点

✅ 所有测试通过！
```

### 步骤 2: 启动开发服务器

```bash
npm run dev
```

### 步骤 3: 访问图谱页面

在浏览器中打开: `http://localhost:4321/graph`

### 步骤 4: 功能验证清单

打开浏览器开发者工具 (F12)，检查：

#### ✅ 基础渲染
- [ ] 页面正常加载，无白屏
- [ ] 图谱组件正常显示
- [ ] 控制台无 `window is not defined` 错误
- [ ] 控制台无 `ForceGraph2D is not defined` 错误

#### ✅ 数据加载
- [ ] 节点正常显示
- [ ] 链接正常显示
- [ ] 图例显示节点和链接数量

#### ✅ 交互功能
- [ ] 点击节点可以跳转到文章
- [ ] 悬停节点时高亮相关节点
- [ ] 可以拖拽节点调整位置
- [ ] 滚轮缩放正常工作
- [ ] 拖拽背景可以平移视图

#### ✅ 主题适配
- [ ] 浅色模式下颜色正常
- [ ] 深色模式下颜色正常
- [ ] 切换主题时图谱颜色实时更新

#### ✅ 响应式
- [ ] 在桌面浏览器正常显示
- [ ] 在移动设备（或开发者工具模拟）正常显示

---

## 🐛 常见问题排查

### 问题 1: 图谱显示"加载中..."不消失

**原因**: 数据接口未正常返回

**解决方法**:
1. 检查 `/api/graph-data` 是否可访问
2. 打开 `http://localhost:4321/api/graph-data`
3. 应该看到 JSON 格式的节点和链接数据

**如果看不到数据**:
```bash
# 检查数据库连接
npm run diagnose

# 重新导入测试数据（如果需要）
npm run import
```

### 问题 2: 控制台报错 "Cannot read property 'x' of undefined"

**原因**: 节点位置未初始化完成就尝试渲染

**解决方法**: 已在修复中处理，刷新页面即可

### 问题 3: 点击节点无反应

**原因**: 事件处理器未正确绑定

**检查**:
```typescript
// 在浏览器控制台运行
console.log(window.location.href); // 应该看到 URL 变化
```

**如果仍无反应**: 检查 `src/components/KnowledgeGraph.tsx` 的 `handleNodeClick` 函数

### 问题 4: 深色模式颜色不对

**原因**: CSS 变量未正确加载

**解决方法**:
```bash
# 检查 src/styles/quartz/variables.css 是否存在
ls src/styles/quartz/variables.css

# 检查 darkmode.css 是否存在
ls src/styles/quartz/darkmode.css
```

**如果文件不存在**: 从文档中复制相关 CSS 文件

---

## 📊 性能基准参考

### 预期性能指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 初始加载时间 | < 2 秒 | 打开开发者工具 → Network 面板 |
| 渲染帧率 | 60 fps | 开发者工具 → Performance 面板 |
| 内存占用 | < 100 MB | 开发者工具 → Memory 面板 |
| 交互响应时间 | < 100 ms | 点击节点后跳转的延迟 |

### 性能测试方法

**测试 1: 初始加载时间**
```
1. 打开开发者工具 (F12)
2. 切换到 Network 面板
3. 刷新页面 (Ctrl+R)
4. 查看 DOMContentLoaded 时间（应 < 2 秒）
```

**测试 2: 渲染帧率**
```
1. 打开开发者工具 (F12)
2. 切换到 Performance 面板
3. 点击 Record
4. 拖拽图谱节点 5 秒
5. 停止录制
6. 查看 FPS 图表（应稳定在 60fps）
```

**测试 3: 内存占用**
```
1. 打开开发者工具 (F12)
2. 切换到 Memory 面板
3. 点击 "Take heap snapshot"
4. 查看 Total size（应 < 100 MB）
```

---

## 🎨 视觉效果验证

### 预期效果图

**浅色模式**:
- 当前节点: 绿色 (#5b8a72)
- 已访问节点: 棕色 (#8b6f56)
- 未访问节点: 灰色 (#a8a8a8)
- 链接: 浅灰色 (#d4d4d4)

**深色模式**:
- 当前节点: 青绿色 (#84a59d)
- 已访问节点: 浅棕色 (#a18276)
- 未访问节点: 深灰色 (#646464)
- 链接: 深灰色 (#393639)

### 交互效果

**悬停节点时**:
- 节点标签放大 1.05 倍
- 相关节点和链接高亮
- 无关节点和链接变淡

**拖拽节点时**:
- 节点跟随鼠标移动
- 连接的链接实时更新
- 其他节点受力导向影响

---

## 📝 下一步行动

### 如果验证通过 ✅

恭喜！图谱组件已修复成功。

**可选的后续优化** (参考 `KNOWLEDGE_GRAPH_FIX_ANALYSIS.md`):

1. **阶段 1 (1-2 天)**:
   - 添加错误边界
   - 优化数据加载（重试机制）
   - 添加性能监控

2. **阶段 2 (3-5 天)**:
   - 实现标签节点功能
   - 添加全局/局部视图切换
   - 节点大小基于度数

3. **阶段 3 (1-2 周)**:
   - 搜索和过滤功能
   - SPA 导航集成
   - PixiJS 高性能渲染（仅在必要时）

### 如果验证失败 ❌

请按以下顺序排查：

1. **检查控制台错误**:
   ```
   打开浏览器开发者工具 (F12)
   查看 Console 面板的错误信息
   复制完整错误堆栈
   ```

2. **检查网络请求**:
   ```
   打开 Network 面板
   查看 /api/graph-data 请求是否成功
   检查返回的数据格式
   ```

3. **检查组件状态**:
   ```javascript
   // 在浏览器控制台运行
   console.log(document.querySelector('.graph'));
   console.log(document.querySelector('.graph-outer'));
   ```

4. **回滚修改** (如果需要):
   ```bash
   git checkout src/components/KnowledgeGraph.tsx
   git checkout src/pages/graph.astro
   ```

5. **提供反馈**:
   - 错误信息截图
   - 浏览器版本
   - 节点和链接数量
   - 操作系统

---

## 🆘 获取帮助

如果遇到无法解决的问题：

1. 查看完整分析文档: `KNOWLEDGE_GRAPH_FIX_ANALYSIS.md`
2. 查看集成文档: `GRAPH_INTEGRATION.md`
3. 查看 Quartz 对比分析: `QUARTZ_MIGRATION_GAP_ANALYSIS.md`

---

**验证清单**:

- [ ] 运行 `npm run test:graph` 通过
- [ ] 访问 `/graph` 页面正常显示
- [ ] 控制台无错误
- [ ] 节点可点击跳转
- [ ] 悬停高亮正常
- [ ] 缩放拖拽流畅
- [ ] 深色模式正常
- [ ] 性能达标

**验证完成日期**: ___________  
**验证人**: ___________  
**备注**: ___________

